<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <title>Messages</title>
    </head>

<body>

    <main th:fragment="main" class="px-4 py-6 md:px-6 md:py-10">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6 md:mb-8">My Conversations</h2>

        <div th:if="${errorMessage}" class="alert alert-danger mb-6" th:text="${errorMessage}"></div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <section>
                <h3 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200 flex items-center gap-2">
                    <i class="fas fa-user-friends text-purple-600 text-lg"></i>
                    <span>Private Chats</span>
                </h3>
                <div th:if="${privateChatPreviews != null and !privateChatPreviews.isEmpty()}" class="space-y-3">
                    <a th:each="preview : ${privateChatPreviews}"
                       th:href="${preview.targetLink}"
                       class="flex items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md hover:border-purple-200 transition-all duration-150 block hover:no-underline">
                       <div class="flex-shrink-0 w-12 h-12 rounded-full overflow-hidden border-2 border-gray-200 bg-gray-100 flex items-center justify-center mr-4">
                            <img th:if="${preview.targetImageUrl != null}"
                                 th:src="@{${preview.targetImageUrl}}"
                                 alt="Avatar"
                                 class="w-full h-full object-cover"
                                 onerror="this.onerror=null; this.parentElement.innerHTML = '<i class=\'fas fa-user text-xl text-gray-400\'></i>';">
                            <i th:unless="${preview.targetImageUrl != null}" class="fas fa-user text-xl text-gray-400"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="text-base font-semibold text-gray-800 truncate" th:text="${preview.targetName}">Friend Name</p>
                            <p class="text-xs text-gray-500 truncate"
                               th:if="${preview.targetLink != null}"
                               th:text="${#strings.substringAfter(preview.targetLink, '/chat/private/')}">
                               username@example.com
                            </p>
                            <div class="text-sm text-gray-600 mt-1 flex justify-between items-center">
                                <span class="truncate flex-grow mr-2"> <strong th:if="${preview.lastMessageSender != null}" th:text="${preview.lastMessageSender + ': '}" class="font-medium text-gray-700">Sender: </strong>
                                    <i th:if="${preview.lastMessageIsAttachment}" class="fas fa-paperclip text-gray-400 mr-1 text-xs"></i>
                                    <span th:text="${#strings.abbreviate(preview.lastMessageContent, 40)}">Last message...</span>
                                </span>
                                <span th:if="${preview.lastMessageTimestamp != null}"
                                      class="text-xs text-gray-400 flex-shrink-0 whitespace-nowrap"
                                      th:text="${#temporals.format(preview.lastMessageTimestamp, 'MMM dd, HH:mm')}">
                                      Timestamp
                                </span>
                            </div>
                        </div>
                    </a>
                </div>
                <div th:if="${privateChatPreviews == null or privateChatPreviews.isEmpty()}" class="text-center text-gray-500 py-8 px-4 italic border border-dashed border-gray-300 rounded-lg bg-gray-50 mt-4">
                     <i class="fas fa-comments text-2xl text-gray-400 block mb-2"></i>
                    <span>You have no private chats yet.</span>
                    <a th:href="@{/friends/search}" class="block mt-1 font-medium text-purple-600 hover:text-purple-800 hover:underline">Find friends to start chatting</a>.
                </div>
            </section>

            <section>
                 <h3 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200 flex items-center gap-2">
                    <i class="fas fa-chalkboard-teacher text-blue-600 text-lg"></i>
                    <span>Class Chats</span>
                </h3>
                 <div th:if="${classChatPreviews != null and !classChatPreviews.isEmpty()}" class="space-y-3">
                     <a th:each="preview : ${classChatPreviews}"
                       th:href="${preview.targetLink}"
                       class="flex items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md hover:border-blue-200 transition-all duration-150 block hover:no-underline"> <div class="flex-shrink-0 w-12 h-12 rounded-lg overflow-hidden border-2 border-blue-200 bg-blue-50 flex items-center justify-center mr-4">
                            <img th:if="${preview.targetImageUrl != null}"
                                 th:src="@{${preview.targetImageUrl}}"
                                 alt="Class Image"
                                 class="w-full h-full object-cover"
                                 onerror="this.onerror=null; this.parentElement.innerHTML = '<i class=\'fas fa-school text-xl text-blue-400\'></i>';">
                            <i th:unless="${preview.targetImageUrl != null}" class="fas fa-school text-xl text-blue-400"></i>
                        </div>
                         <div class="flex-grow min-w-0">
                            <p class="text-base font-semibold text-gray-800 truncate" th:text="${preview.targetName}">Class Name</p>
                            <div class="text-sm text-gray-600 mt-1 flex justify-between items-center">
                                <span class="truncate flex-grow mr-2"> <strong th:if="${preview.lastMessageSender != null}" th:text="${preview.lastMessageSender + ': '}" class="font-medium text-gray-700">Sender: </strong>
                                    <span th:text="${#strings.abbreviate(preview.lastMessageContent, 40)}">Last message...</span>
                                </span>
                                <span th:if="${preview.lastMessageTimestamp != null}"
                                      class="text-xs text-gray-400 flex-shrink-0 whitespace-nowrap"
                                      th:text="${#temporals.format(preview.lastMessageTimestamp, 'MMM dd, HH:mm')}">
                                      Timestamp
                                </span>
                            </div>
                        </div>
                    </a>
                </div>
                 <div th:if="${classChatPreviews == null or classChatPreviews.isEmpty()}" class="text-center text-gray-500 py-8 px-4 italic border border-dashed border-gray-300 rounded-lg bg-gray-50 mt-4">
                     <i class="fas fa-school text-2xl text-gray-400 block mb-2"></i>
                    <span>You are not part of any classes with chat features.</span>
                    <a th:if="${#authorization.expression('hasRole(''ROLE_STUDENT'')')}"
                       th:href="@{/student/classes/join}"
                       class="block mt-1 font-medium text-purple-600 hover:text-purple-800 hover:underline">Join a class</a>
                </div>
            </section>

        </div>

        <div class="mt-10 text-center">
             <a th:href="@{/dashboard}" class="text-sm font-medium text-purple-600 hover:text-purple-800 hover:underline">&larr; Back to Dashboard</a>
        </div>

    </main>

</body>
</html>
