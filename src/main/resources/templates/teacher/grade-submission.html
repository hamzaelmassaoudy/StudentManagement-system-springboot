<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
    <title th:text="'Grade Submission - ' + ${submission.assignment.title}">Grade Submission</title>
    </head>
<body>

    <main th:fragment="main">
        <h2 class="text-2xl font-semibold text-gray-700 mb-2" th:text="'Grade Submission for: ' + ${submission.assignment.title}">Grade Submission</h2>
        <div class="text-sm text-gray-500 mb-6 pb-4 border-b border-gray-200">
             <p>
                 Student: <strong th:text="${submission.student?.firstName + ' ' + submission.student?.lastName}" class="text-gray-700">Student Name</strong>
                 (<span th:text="'ID: ' + ${submission.student?.studentId}">Student ID</span>)
             </p>
             <p>
                 Submitted: <span th:text="${#temporals.format(submission.submissionDate, 'yyyy-MM-dd HH:mm')}">Submission Date</span>
             </p>
        </div>

        <div class="content-card p-6 max-w-2xl mx-auto">

            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Submitted Work</h3>
                <div th:if="${submission.contentText != null and !submission.contentText.isBlank()}" class="mb-3">
                    <h4 class="text-sm font-medium text-gray-600 mb-1">Submitted Text:</h4>
                    <pre th:text="${submission.contentText}">Submitted text content.</pre> </div>
                <div th:if="${submission.filePath != null}">
                    <h4 class="text-sm font-medium text-gray-600 mb-1">Submitted File:</h4>
                    <a th:href="@{/download/submission/{filename}(filename=${submission.filePath})}"
                       th:text="${submission.originalFilename}"
                       target="_blank"
                       class="download-link text-purple-600 hover:text-purple-800"> <i class="fas fa-download"></i>
                    </a>
                </div>
                <div th:if="${submission.contentText == null or submission.contentText.isBlank()}"
                     th:unless="${submission.filePath != null}"
                     class="text-gray-500 italic text-sm">
                     No text or file submitted.
                </div>
            </div>

            <hr class="my-6 border-gray-200">

            <h3 class="text-lg font-semibold text-gray-800 mb-4">Enter Grade and Feedback</h3>

            <div th:if="${#fields.hasErrors('gradeDto.grade')}" class="alert alert-danger mb-4">
                <p th:each="err : ${#fields.errors('gradeDto.grade')}" th:text="${err}"></p>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger mb-4" th:text="${errorMessage}"></div>

             <form th:action="@{/teacher/submissions/{submissionId}/grade(submissionId=${submission.id})}"
                  th:object="${gradeDto}"
                  method="post" class="space-y-4">

                <div>
                    <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Grade Score (0-100)</label>
                    <input type="number" id="grade" th:field="*{grade}"
                           min="0" max="100" step="0.1" required class="w-full sm:w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                           th:classappend="${#fields.hasErrors('grade')} ? 'border-red-500' : ''"
                           placeholder="Enter score (e.g., 85.5)">
                    <p th:if="${#fields.hasErrors('grade')}" th:errors="*{grade}" class="text-xs text-red-600 mt-1"></p>
                </div>

                <div>
                    <label for="feedback" class="block text-sm font-medium text-gray-700 mb-1">Feedback (Optional)</label>
                    <textarea id="feedback" th:field="*{feedback}" rows="6"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                              placeholder="Provide constructive feedback..."></textarea>
                    <p th:if="${#fields.hasErrors('feedback')}" th:errors="*{feedback}" class="text-xs text-red-600 mt-1"></p>
                </div>

                <div class="flex items-center justify-end space-x-3 pt-4">
                    <a th:href="@{/teacher/assignments/{assignmentId}/submissions(assignmentId=${submission.assignment.id})}"
                       class="btn btn-secondary btn-sm">Cancel</a>
                    <button type="submit" class="btn btn-success"> <i class="fas fa-save mr-1"></i>
                        <span th:if="${submission.grade == null and (submission.feedback == null or submission.feedback.isBlank())}">Save Grade</span>
                        <span th:unless="${submission.grade == null and (submission.feedback == null or submission.feedback.isBlank())}">Update Grade</span>
                    </button>
                </div>
            </form>
            </div>
        <div class="mt-8 text-center">
             <a th:href="@{/dashboard}" class="text-sm text-purple-600 hover:underline">&larr; Back to Dashboard</a>
        </div>
    </main>

</body>
</html>
