<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Student Management System</title>
    <style>
        /* Define custom styles for dashboard action buttons if needed, distinct from standard .btn */
        .dash-action-btn {
             @apply inline-flex items-center justify-center p-1.5 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-purple-500 transition-colors duration-150;
        }
        .dash-action-btn.submit, .dash-action-btn.start-quiz { @apply hover:text-green-600; }
        .dash-action-btn.view, .dash-action-btn.view-result { @apply hover:text-blue-600; }
        .dash-action-btn.grade { @apply hover:text-yellow-600; }
        .dash-action-btn.makeup { @apply hover:text-orange-500; }
        .dash-action-btn.continue-quiz { @apply hover:text-yellow-600; }


        /* Custom Badge Styles for Grades & Status */
        .dashboard-list-item-badge {
             @apply inline-block px-2.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap;
        }
        .badge-grade-pass { @apply bg-green-100 text-green-800; }
        .badge-grade-fail { @apply bg-red-100 text-red-800; }
        .badge-grade-pending { @apply bg-blue-100 text-blue-800; }
        .badge-grade-ungraded { @apply bg-yellow-100 text-yellow-800; }
        /* Badges for Makeup Status */
        .badge-status-approved { @apply bg-green-100 text-green-800; }
        .badge-status-rejected { @apply bg-red-100 text-red-800; }


        /* Admin Action Card Styles */
        .action-card {
            @apply block p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md hover:border-purple-300 transition-all duration-200 text-decoration-none; /* Added text-decoration-none */
        }
        .action-card:hover {
             @apply no-underline; /* Ensure no underline on hover */
        }
        .action-card-icon-wrapper {
            @apply inline-flex items-center justify-center w-12 h-12 mb-4 rounded-full bg-purple-100 text-purple-600;
        }
        .action-card-icon {
            @apply w-6 h-6;
        }
        .action-card-title {
            @apply mb-1 text-lg font-semibold text-gray-900 group-hover:text-purple-700 transition-colors duration-200;
        }
        .action-card-description {
            @apply text-sm text-gray-600;
        }

        /* Style for teacher comment tooltip/display */
        .teacher-comment {
            @apply block text-xs text-gray-500 mt-1 italic truncate;
        }
        .teacher-comment i {
             @apply mr-1 text-gray-400;
        }
    </style>
</head>

<body>

    <main th:fragment="main" class="space-y-8 md:space-y-10 px-4 py-6 md:px-6 md:py-8 lg:py-10">
        <div class="mb-6 md:mb-8">
             <div th:if="${currentUser != null}">
                 <h1 class="text-2xl md:text-3xl font-bold text-gray-900"> Welcome, <span th:text="${currentUser.firstName}" class="text-purple-700">User</span>!
                 </h1>
                 <p class="mt-1 md:mt-2 text-sm md:text-base text-gray-600"> Here's your dashboard summary. Let's get things done! âœ¨ </p>
             </div>
             <div th:unless="${currentUser != null}">
                 <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Dashboard</h1>
             </div>
        </div>

        <div th:if="${dashboardError}" class="alert alert-danger" role="alert" th:text="${dashboardError}"></div>
        <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>

        <div sec:authorize="hasRole('STUDENT')" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 md:gap-8">

            <section class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                    <i class="fas fa-clipboard-list text-xl text-purple-600"></i>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Pending Assignments</h2>
                </div>
                <div th:if="${pendingAssignments != null and !pendingAssignments.isEmpty()}" class="space-y-3">
                    <div th:each="assignment : ${pendingAssignments}" class="flex items-center justify-between gap-4 p-3 rounded-md hover:bg-gray-50 border border-gray-100">
                        <div class="flex items-center gap-3 min-w-0">
                             <i class="fas fa-file-alt text-base text-purple-500 flex-shrink-0"></i>
                             <div class="min-w-0">
                                <a th:href="@{/student/assignments/{id}/submit(id=${assignment.id})}" class="block truncate text-sm font-medium text-gray-900 hover:text-purple-700 hover:underline" th:text="${assignment.title}">Assignment Title</a>
                                <p class="block truncate text-xs text-gray-500 mt-0.5">Due: <span th:text="${assignment.dueDate != null ? #temporals.format(assignment.dueDate, 'MMM dd, HH:mm') : 'N/A'}"></span> | Class: <span th:text="${assignment.schoolClass?.name}"></span></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                             <a th:href="@{/student/assignments/{id}/submit(id=${assignment.id})}" class="dash-action-btn submit" title="Submit Assignment"><span class="sr-only">Submit Assignment</span> <i class="fas fa-upload"></i></a>
                        </div>
                    </div>
                    <div th:if="${pendingAssignments.size() >= 5}" class="pt-3 text-right border-t border-gray-100 mt-3">
                         <a th:href="@{/student/assignments}" class="text-sm font-medium text-purple-600 hover:text-purple-800 hover:underline">View All Assignments &rarr;</a>
                     </div>
                </div>
                 <div th:if="${pendingAssignments == null or pendingAssignments.isEmpty()}" class="rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 p-6 text-center text-gray-500 italic mt-4"><i class="fas fa-check-circle text-green-500 mr-2 text-lg"></i><span>No pending assignments found. Great job!</span></div>
            </section>

            <section class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                    <i class="fas fa-star text-xl text-yellow-500"></i>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Latest Grades</h2>
                </div>
                <div th:if="${latestGrades != null and !latestGrades.isEmpty()}" class="space-y-3">
                    <div th:each="submission : ${latestGrades}" class="flex items-center justify-between gap-4 p-3 rounded-md hover:bg-gray-50 border border-gray-100">
                         <div class="flex items-center gap-3 min-w-0">
                             <i class="fas fa-check-double text-base flex-shrink-0" th:classappend="${submission.numericalGrade == null ? 'text-blue-500' : (submission.numericalGrade >= 60 ? 'text-green-500' : 'text-red-500')}"></i>
                             <div class="min-w-0">
                                <a th:href="@{/student/assignments/{id}/submit(id=${submission.assignment.id})}" class="block truncate text-sm font-medium text-gray-900 hover:text-purple-700 hover:underline" th:text="${submission.assignment?.title}">Assignment Title</a>
                                <p class="block truncate text-xs text-gray-500 mt-0.5">Graded: <span th:text="${submission.gradedDate != null ? #temporals.format(submission.gradedDate, 'MMM dd, yyyy') : 'N/A'}"></span> | Class: <span th:text="${submission.assignment?.schoolClass?.name}"></span></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="dashboard-list-item-badge" th:text="${submission.grade ?: 'Pending'}" th:classappend="${submission.numericalGrade == null ? 'badge-grade-pending' : (submission.numericalGrade >= 60 ? 'badge-grade-pass' : 'badge-grade-fail')}">A+</span>
                             <th:block th:if="${canRequestMakeupMap.get(submission.id)}">
                                 <a th:href="@{/student/makeup/request/{subId}(subId=${submission.id})}" class="dash-action-btn makeup" title="Apply for Makeup"><span class="sr-only">Apply for Makeup</span><i class="fas fa-redo-alt"></i></a>
                             </th:block>
                             <a th:href="@{/student/assignments/{id}/submit(id=${submission.assignment.id})}" class="dash-action-btn view" title="View Submission"><span class="sr-only">View Submission</span><i class="fas fa-eye"></i></a>
                        </div>
                    </div>
                    </div>
                 <div th:if="${latestGrades == null or latestGrades.isEmpty()}" class="rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 p-6 text-center text-gray-500 italic mt-4"><i class="fas fa-hourglass-half text-gray-400 mr-2 text-lg"></i><span>No grades have been posted yet.</span></div>
            </section>

            <section class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                    <i class="fas fa-question-circle text-xl text-blue-600"></i>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Pending Quizzes</h2>
                </div>
                <div th:if="${pendingQuizzes != null and !pendingQuizzes.isEmpty()}" class="space-y-3">
                    <div th:each="quiz : ${pendingQuizzes}" class="flex items-center justify-between gap-4 p-3 rounded-md hover:bg-gray-50 border border-gray-100">
                        <div class="flex items-center gap-3 min-w-0">
                             <i class="fas fa-stopwatch text-base text-blue-500 flex-shrink-0"></i>
                             <div class="min-w-0">
                                <a th:href="@{/student/quizzes/{id}/take(id=${quiz.id})}" class="block truncate text-sm font-medium text-gray-900 hover:text-purple-700 hover:underline" th:text="${quiz.title}">Quiz Title</a>
                                <p class="block truncate text-xs text-gray-500 mt-0.5">Due: <span th:text="${quiz.dueDate != null ? #temporals.format(quiz.dueDate, 'MMM dd, HH:mm') : 'N/A'}"></span> | Class: <span th:text="${quiz.schoolClass?.name}"></span></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <th:block th:with="attempt=${studentAttemptMap != null ? studentAttemptMap.get(quiz.id) : null}">
                                <a th:if="${attempt != null and attempt.status.name() == 'IN_PROGRESS'}"
                                   th:href="@{/student/quizzes/{id}/take(id=${quiz.id})}"
                                   class="dash-action-btn continue-quiz" title="Continue Quiz">
                                    <span class="sr-only">Continue Quiz</span> <i class="fas fa-edit"></i>
                                </a>
                                <a th:unless="${attempt != null and attempt.status.name() == 'IN_PROGRESS'}"
                                   th:href="@{/student/quizzes/{id}/take(id=${quiz.id})}"
                                   class="dash-action-btn start-quiz" title="Start Quiz">
                                    <span class="sr-only">Start Quiz</span> <i class="fas fa-play"></i>
                                </a>
                            </th:block>
                        </div>
                    </div>
                    <div th:if="${pendingQuizzes.size() >= 5}" class="pt-3 text-right border-t border-gray-100 mt-3">
                         <a th:href="@{/student/quizzes}" class="text-sm font-medium text-purple-600 hover:text-purple-800 hover:underline">View All Quizzes &rarr;</a>
                     </div>
                </div>
                 <div th:if="${pendingQuizzes == null or pendingQuizzes.isEmpty()}" class="rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 p-6 text-center text-gray-500 italic mt-4"><i class="fas fa-check-double text-green-500 mr-2 text-lg"></i><span>No pending quizzes found.</span></div>
            </section>

            <section class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                    <i class="fas fa-history text-xl text-blue-500"></i>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Makeup Request Status</h2>
                </div>
                <div th:if="${reviewedMakeupRequests != null and !reviewedMakeupRequests.isEmpty()}" class="space-y-3">
                    <div th:each="req : ${reviewedMakeupRequests}" class="flex items-center justify-between gap-4 p-3 rounded-md hover:bg-gray-50 border border-gray-100">
                        <div class="flex items-center gap-3 min-w-0">
                            <i th:if="${req.status.name() == 'APPROVED'}" class="fas fa-check-circle text-base text-green-500 flex-shrink-0" title="Approved"></i>
                            <i th:if="${req.status.name() == 'REJECTED'}" class="fas fa-times-circle text-base text-red-500 flex-shrink-0" title="Rejected"></i>
                             <div class="min-w-0">
                                <a th:href="@{/student/assignments/{id}/submit(id=${req.submission.assignment.id})}" class="block truncate text-sm font-medium text-gray-900 hover:text-purple-700 hover:underline" th:text="${req.submission?.assignment?.title}">Assignment Title</a>
                                <p class="block truncate text-xs text-gray-500 mt-0.5">Reviewed: <span th:text="${req.reviewedAt != null ? #temporals.format(req.reviewedAt, 'MMM dd, yyyy') : 'N/A'}"></span> | <span th:text="${req.submission?.assignment?.schoolClass?.name}">Class</span></p>
                                <p th:if="${req.teacherComment != null and !req.teacherComment.isBlank()}" class="teacher-comment" th:title="${req.teacherComment}">
                                    <i class="fas fa-comment-alt"></i><span th:text="${req.teacherComment}"></span>
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                             <span class="dashboard-list-item-badge"
                                   th:text="${#strings.capitalize(req.status.name().toLowerCase())}"
                                   th:classappend="${req.status.name() == 'APPROVED' ? 'badge-status-approved' : 'badge-status-rejected'}">
                                   Status
                             </span>
                             <a th:href="@{/student/assignments/{id}/submit(id=${req.submission.assignment.id})}" class="dash-action-btn view" title="View Submission">
                                 <span class="sr-only">View Submission</span>
                                 <i class="fas fa-eye"></i>
                             </a>
                        </div>
                    </div>
                </div>
                 <div th:if="${reviewedMakeupRequests == null or reviewedMakeupRequests.isEmpty()}" class="rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 p-6 text-center text-gray-500 italic mt-4">
                     <i class="fas fa-info-circle text-gray-400 mr-2 text-lg"></i>
                     <span>No reviewed makeup requests found.</span>
                 </div>
            </section>

        </div>

        <div sec:authorize="hasRole('TEACHER')" class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">

            <section class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                    <i class="fas fa-edit text-xl text-orange-500"></i>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Assignments Needing Grading</h2>
                </div>
                <div th:if="${assignmentsToGrade != null and !assignmentsToGrade.isEmpty()}" class="space-y-3">
                    <div th:each="entry : ${assignmentsToGrade}" class="flex items-center justify-between gap-4 p-3 rounded-md hover:bg-gray-50 border border-gray-100">
                        <div class="flex items-center gap-3 min-w-0">
                             <i class="fas fa-inbox text-base text-orange-500 flex-shrink-0"></i>
                             <div class="min-w-0">
                                <a th:href="@{/teacher/assignments/{id}/submissions(id=${entry.key.id})}" class="block truncate text-sm font-medium text-gray-900 hover:text-purple-700 hover:underline" th:text="${entry.key.title}">Assignment Title</a>
                                <p class="block truncate text-xs text-gray-500 mt-0.5">Class: <span th:text="${entry.key.schoolClass?.name}"></span> | Due: <span th:text="${entry.key.dueDate != null ? #temporals.format(entry.key.dueDate, 'MMM dd, yyyy') : 'N/A'}"></span></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="dashboard-list-item-badge badge-grade-ungraded" th:text="${#lists.size(entry.value) + ' Ungraded'}">5 Ungraded</span>
                             <a th:href="@{/teacher/assignments/{id}/submissions(id=${entry.key.id})}" class="dash-action-btn grade" title="Grade Submissions"><span class="sr-only">Grade Submissions</span><i class="fas fa-pen"></i></a>
                        </div>
                    </div>
                    <div th:if="${assignmentsToGrade.size() >= 5}" class="pt-3 text-right border-t border-gray-100 mt-3">
                        <a th:href="@{/teacher/classes}" class="text-sm font-medium text-purple-600 hover:text-purple-800 hover:underline">View All Classes &rarr;</a>
                    </div>
                </div>
                 <div th:if="${assignmentsToGrade == null or assignmentsToGrade.isEmpty()}" class="rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 p-6 text-center text-gray-500 italic mt-4"><i class="fas fa-check-circle text-green-500 mr-2 text-lg"></i><span>No assignment submissions currently awaiting grading. All caught up!</span></div>
            </section>

            <section class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200">
                <div class="flex items-center justify-between gap-3 mb-4 pb-3 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-history text-xl text-blue-500"></i>
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Makeup Requests</h2>
                    </div>
                    <span th:if="${pendingMakeupRequestCount != null and pendingMakeupRequestCount > 0}"
                          class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full"
                          th:text="${pendingMakeupRequestCount}">
                          3
                    </span>
                </div>
                <div th:if="${pendingMakeupRequestCount != null and pendingMakeupRequestCount > 0}">
                    <p class="text-sm text-gray-600 mb-4">
                        You have <strong th:text="${pendingMakeupRequestCount}"></strong> pending makeup request(s) to review.
                    </p>
                    <div class="text-right">
                        <a th:href="@{/teacher/makeup-requests}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-eye mr-1"></i> Review Requests
                        </a>
                    </div>
                </div>
                 <div th:if="${pendingMakeupRequestCount == null or pendingMakeupRequestCount == 0}" class="rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 p-6 text-center text-gray-500 italic mt-4">
                     <i class="fas fa-check-circle text-green-500 mr-2 text-lg"></i>
                     <span>No pending makeup requests.</span>
                 </div>
            </section>

            <section class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200 lg:col-span-2">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                    <i class="fas fa-marker text-xl text-indigo-500"></i>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Quizzes Needing Grading</h2>
                </div>
                <div th:if="${pendingQuizGrading != null and !pendingQuizGrading.isEmpty()}" class="space-y-3">
                    <div th:each="attempt : ${pendingQuizGrading}" class="flex items-center justify-between gap-4 p-3 rounded-md hover:bg-gray-50 border border-gray-100">
                        <div class="flex items-center gap-3 min-w-0">
                             <i class="fas fa-user-edit text-base text-indigo-500 flex-shrink-0"></i>
                             <div class="min-w-0">
                                <a th:href="@{/teacher/attempts/{id}/grade(id=${attempt.id})}" class="block truncate text-sm font-medium text-gray-900 hover:text-purple-700 hover:underline" th:text="${attempt.quiz?.title}">Quiz Title</a>
                                <p class="block truncate text-xs text-gray-500 mt-0.5">Student: <span th:text="${attempt.student?.firstName + ' ' + attempt.student?.lastName}"></span> | Submitted: <span th:text="${attempt.endTime != null ? #temporals.format(attempt.endTime, 'MMM dd, HH:mm') : 'N/A'}"></span></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="dashboard-list-item-badge bg-indigo-100 text-indigo-800">Needs Grading</span>
                             <a th:href="@{/teacher/attempts/{id}/grade(id=${attempt.id})}" class="dash-action-btn grade" title="Grade Attempt"><span class="sr-only">Grade Attempt</span><i class="fas fa-pen"></i></a>
                        </div>
                    </div>
                    <div th:if="${pendingQuizGrading.size() >= 5}" class="pt-3 text-right border-t border-gray-100 mt-3">
                        <a th:href="@{/teacher/classes}" class="text-sm font-medium text-purple-600 hover:text-purple-800 hover:underline">View All Quizzes &rarr;</a>
                    </div>
                </div>
                 <div th:if="${pendingQuizGrading == null or pendingQuizGrading.isEmpty()}" class="rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 p-6 text-center text-gray-500 italic mt-4"><i class="fas fa-check-circle text-green-500 mr-2 text-lg"></i><span>No quiz attempts currently awaiting grading.</span></div>
            </section>

        </div>

        <div sec:authorize="hasRole('ADMIN')" class="space-y-6 md:space-y-8">
            <section class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200">
                 <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                    <i class="fas fa-cogs text-xl text-gray-600"></i>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Admin Actions</h2>
                 </div>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:gap-6">
                     <a th:href="@{/admin/teachers}" class="group action-card"><span class="action-card-icon-wrapper"><i class="fas fa-user-shield action-card-icon"></i></span><h3 class="action-card-title">Manage Teachers</h3><p class="action-card-description">Add, edit, or remove teacher accounts.</p></a>
                     <a href="#" class="group action-card opacity-50 cursor-not-allowed" aria-disabled="true" onclick="return false;"><span class="action-card-icon-wrapper !bg-blue-100 !text-blue-600"><i class="fas fa-user-graduate action-card-icon"></i></span><h3 class="action-card-title !text-gray-900">Manage Students</h3><p class="action-card-description">View and manage student profiles (Not Implemented).</p></a>
                     <a href="#" class="group action-card opacity-50 cursor-not-allowed" aria-disabled="true" onclick="return false;"><span class="action-card-icon-wrapper !bg-green-100 !text-green-600"><i class="fas fa-chalkboard-teacher action-card-icon"></i></span><h3 class="action-card-title !text-gray-900">Manage Classes</h3><p class="action-card-description">Oversee all classes in the system (Not Implemented).</p></a>
                     <a href="#" class="group action-card opacity-50 cursor-not-allowed" aria-disabled="true" onclick="return false;"><span class="action-card-icon-wrapper !bg-gray-100 !text-gray-600"><i class="fas fa-cog action-card-icon"></i></span><h3 class="action-card-title !text-gray-900">System Settings</h3><p class="action-card-description">Configure application settings (Not Implemented).</p></a>
                 </div>
            </section>
        </div>

    </main>
</body>
</html>
