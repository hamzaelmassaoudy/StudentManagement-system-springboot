<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
    <title th:text="'Submit Assignment: ' + ${assignment.title}">Submit Assignment</title>
    <style>
        /* Enhanced grade display - more prominent */
        .grade-display {
            @apply font-bold text-2xl px-4 py-1.5 rounded-lg inline-block shadow-sm; /* Larger, more padding, shadow */
        }
        .grade-pass { @apply bg-green-100 text-green-800 border border-green-300; }
        .grade-fail { @apply bg-red-100 text-red-800 border border-red-300; }
        .grade-pending { @apply bg-blue-100 text-blue-800 border border-blue-300; }
        .grade-makeup-passed { @apply bg-teal-100 text-teal-800 border border-teal-300; } /* For makeup passed */
        .grade-makeup-failed { @apply bg-rose-100 text-rose-800 border border-rose-300; } /* For makeup failed final */


        /* Enhanced preformatted text blocks */
        pre.submission-text, pre.feedback-text {
            @apply bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-800 whitespace-pre-wrap break-words shadow-sm leading-relaxed font-mono; /* Added font-mono */
        }
        pre.feedback-text {
             @apply bg-purple-50 border-purple-200 text-purple-900;
        }

        /* Custom file input styling */
        input[type="file"].custom-file-input::file-selector-button {
            @apply mr-4 py-2 px-5 rounded-md border-0 text-sm font-semibold
                   bg-purple-100 text-purple-700 cursor-pointer
                   hover:bg-purple-200 transition-colors duration-200; /* Smoother transition */
        }
         input[type="file"].custom-file-input {
             @apply block w-full text-sm text-gray-600 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500; /* Changed bg */
         }

        /* Style for the makeup button */
        .makeup-button {
             @apply inline-flex items-center gap-1.5 text-sm font-medium bg-orange-100 text-orange-800 hover:bg-orange-200 border border-orange-300 px-3 py-1.5 rounded-md transition-colors duration-150 shadow-sm; /* Added shadow */
        }
         .makeup-button i { @apply text-xs; }
         .makeup-button:disabled, a.makeup-button.disabled { /* Added a.makeup-button.disabled */
            @apply opacity-60 cursor-not-allowed bg-gray-100 text-gray-500 border-gray-200 shadow-none pointer-events-none;
         }


        /* Section divider */
        .section-divider {
            @apply my-8 border-t border-gray-200; /* Increased margin */
        }

        /* Styling for the previous grade/feedback section in makeup view */
        .previous-submission-details {
            @apply mb-6 p-4 border border-orange-200 bg-orange-50 rounded-lg shadow-sm;
        }
        .previous-submission-details h4 {
             @apply text-base font-semibold text-orange-800 mb-3 flex items-center gap-2;
        }
        .previous-submission-details h4 i {
             @apply text-orange-600;
        }
        .previous-submission-details .grade-info {
            @apply flex items-center gap-3 mb-3;
        }
        .previous-submission-details .feedback-info h5 {
             @apply text-sm font-semibold text-orange-700 mb-1;
        }
         .previous-submission-details .feedback-info pre {
             @apply bg-orange-100 border-orange-200 text-orange-900 text-xs p-3;
         }
         .previous-submission-details .feedback-info p {
             @apply text-xs text-orange-600 italic;
         }

    </style>
</head>
<body>

    <main th:fragment="main" class="px-4 py-6 md:px-6 md:py-8 lg:py-10">
        <div class="mb-8 pb-4 border-b border-gray-300">
             <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2" th:text="${assignment.title}">Assignment Title</h2>
            <div class="text-base text-gray-600 flex flex-wrap gap-x-6 gap-y-1">
                <span class="inline-flex items-center"><i class="fas fa-university mr-2 text-gray-400"></i>Class: <strong th:text="${assignment.schoolClass?.name}" class="ml-1 text-gray-900">Class Name</strong></span>
                <span class="inline-flex items-center"><i class="fas fa-calendar-alt mr-2 text-gray-400"></i>Due: <strong th:text="${#temporals.format(assignment.dueDate, 'MMM dd, HH:mm')}" class="ml-1 text-gray-900">Due Date</strong></span>
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-xl border border-gray-200 p-6 md:p-8 max-w-4xl mx-auto">
            <section class="mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="fas fa-info-circle text-purple-600 text-lg"></i>
                    Instructions
                </h3>
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 text-gray-800 text-base leading-relaxed">
                    <p class="whitespace-pre-wrap" th:text="${assignment.description ?: 'No instructions provided.'}">Assignment description goes here.</p>
                </div>

                <div th:if="${assignment.attachmentPath != null}" class="mt-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-1">Attachment:</h4>
                    <a th:href="@{/download/assignment/{filename}(filename=${assignment.attachmentPath})}"
                       target="_blank"
                       class="inline-flex items-center gap-1.5 text-sm text-purple-700 hover:text-purple-900 hover:underline bg-purple-100 px-4 py-2 rounded-lg border border-purple-200 shadow-sm hover:shadow-md transition-all duration-150">
                        <i class="fas fa-paperclip text-xs"></i>
                        <span th:text="${assignment.attachmentOriginalFilename}">Download Attachment</span>
                    </a>
                </div>
            </section>

            <hr class="section-divider">

            <section>
                <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-paper-plane text-blue-600 text-lg"></i>
                    Your Submission
                </h3>

                <div th:if="${alreadySubmitted and !makeupResubmissionAllowed}" class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 text-blue-900 px-4 py-3 rounded-lg text-sm flex items-center gap-2 shadow-sm" role="alert">
                        <i class="fas fa-check-circle"></i>
                        <p class="font-medium">
                            Submitted on: <span th:text="${#temporals.format(submission.submissionDate, 'MMM dd, HH:mm')}">Submission Date</span>
                            <span th:if="${submission.isMakeupSubmission()}" class="font-semibold text-orange-700">(Makeup Attempt)</span>
                        </p>
                        <span th:if="${makeupStatus == 'PENDING'}" class="ml-auto text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Makeup Pending</span>
                        <span th:if="${makeupStatus == 'REJECTED'}" class="ml-auto text-xs font-semibold bg-red-100 text-red-800 px-2 py-0.5 rounded-full">Makeup Rejected</span>
                        <span th:if="${makeupStatus == 'MAKEUP_PASSED'}" class="ml-auto text-xs font-semibold bg-teal-100 text-teal-800 px-2 py-0.5 rounded-full">Makeup Passed</span>
                        <span th:if="${makeupStatus == 'MAKEUP_FAILED_FINAL'}" class="ml-auto text-xs font-semibold bg-rose-100 text-rose-800 px-2 py-0.5 rounded-full">Makeup Failed</span>
                        <span th:if="${makeupStatus == 'MAKEUP_SUBMITTED_PENDING_GRADE'}" class="ml-auto text-xs font-semibold bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">Makeup Pending Grade</span>
                    </div>

                    <div th:if="${submission.contentText != null and !submission.contentText.isBlank()}">
                        <h4 class="text-base font-semibold text-gray-700 mb-2">Submitted Text:</h4>
                        <pre class="submission-text" th:text="${submission.contentText}">Submitted text content.</pre>
                    </div>
                    <div th:if="${submission.filePath != null}">
                        <h4 class="text-base font-semibold text-gray-700 mb-2">Submitted File:</h4>
                        <a th:href="@{/download/submission/{filename}(filename=${submission.filePath})}"
                           target="_blank"
                           class="inline-flex items-center gap-1.5 text-sm text-purple-700 hover:text-purple-900 hover:underline bg-purple-100 px-4 py-2 rounded-lg border border-purple-200 shadow-sm hover:shadow-md transition-all duration-150">
                            <i class="fas fa-file-download text-xs"></i>
                            <span th:text="${submission.originalFilename}">Submitted File</span>
                        </a>
                    </div>

                    <div th:if="${submission.grade != null or (submission.feedback != null and !submission.feedback.isBlank())}" class="mt-8 pt-6 border-t border-gray-200 space-y-5">
                         <h4 class="text-xl font-semibold text-gray-900 mb-3 flex items-center gap-2">
                             <i class="fas fa-star text-yellow-500 text-lg"></i>
                             Grade & Feedback
                         </h4>
                         <div class="flex items-center gap-4 flex-wrap">
                             <span class="font-semibold text-gray-800 text-lg">Grade:</span>
                             <span th:if="${submission.grade != null}"
                                    class="grade-display"
                                    th:classappend="${submission.isMakeupSubmission() ? (submission.numericalGrade >= 60 ? 'grade-makeup-passed' : 'grade-makeup-failed') : (submission.numericalGrade == null ? 'grade-pending' : (submission.numericalGrade >= 60 ? 'grade-pass' : 'grade-fail'))}"
                                    th:text="${submission.grade}">
                              </span>
                              <span th:unless="${submission.grade != null}" class="text-gray-500 italic text-base">
                                Not graded yet.
                              </span>

                              <a th:if="${submission.numericalGrade != null and submission.numericalGrade < 60 and !submission.isMakeupSubmission() and makeupStatus == 'NONE'}"
                                 th:href="@{/student/makeup/request/{subId}(subId=${submission.id})}"
                                 class="makeup-button" title="Apply for Makeup">
                                  <i class="fas fa-redo-alt"></i>
                                  <span>Request Makeup</span>
                              </a>
                              <span th:if="${makeupStatus == 'REJECTED' and submission.numericalGrade != null and submission.numericalGrade < 60 and !submission.isMakeupSubmission()}"
                                    class="makeup-button disabled" title="Makeup request was rejected">
                                   <i class="fas fa-times-circle"></i>
                                   <span>Makeup Rejected</span>
                              </span>
                         </div>
                         <div>
                             <h5 class="text-base font-semibold text-gray-700 mb-2">Feedback from Teacher:</h5>
                             <div th:if="${submission.feedback != null and !submission.feedback.isBlank()}">
                                 <pre class="feedback-text" th:text="${submission.feedback}">Feedback content goes here.</pre>
                             </div>
                             <p th:unless="${submission.feedback != null and !submission.feedback.isBlank()}" class="text-gray-500 italic text-sm mt-1">
                                No feedback provided yet.
                             </p>
                         </div>
                    </div>
                </div>

                <div th:if="${makeupResubmissionAllowed}" class="previous-submission-details">
                    <h4>
                        <i class="fas fa-history"></i>
                        Original Submission Grade & Feedback
                    </h4>
                    <div class="grade-info">
                        <span class="font-medium text-orange-900 text-sm">Original Grade:</span>
                        <span th:if="${submission.grade != null}"
                              class="grade-display !text-base !px-2 !py-0.5"
                              th:classappend="${submission.numericalGrade == null ? 'grade-pending' : (submission.numericalGrade >= 60 ? 'grade-pass' : 'grade-fail')}"
                              th:text="${submission.grade}">
                        </span>
                        <span th:unless="${submission.grade != null}" class="text-orange-700 italic text-sm">
                            Not Graded
                        </span>
                    </div>
                    <div class="feedback-info">
                        <h5>Feedback from Teacher (Original):</h5>
                        <div th:if="${submission.feedback != null and !submission.feedback.isBlank()}">
                            <pre th:text="${submission.feedback}">Previous feedback content.</pre>
                        </div>
                        <p th:unless="${submission.feedback != null and !submission.feedback.isBlank()}">
                           No feedback was provided on the original submission.
                        </p>
                    </div>
                </div>

                <form th:if="${!alreadySubmitted or makeupResubmissionAllowed}"
                      th:action="@{/student/assignments/{assignmentId}/submit(assignmentId=${assignment.id})}"
                      th:object="${submissionDto}"
                      method="post"
                      enctype="multipart/form-data"
                      class="space-y-6 border-2 border-dashed border-gray-300 p-6 rounded-xl bg-gray-50/50 mt-6">

                     <div th:if="${makeupResubmissionAllowed}" class="alert alert-info text-sm">
                        <i class="fas fa-info-circle mr-1"></i> Your makeup request was approved. This will be your makeup attempt.
                     </div>

                     <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
                     <div th:if="${#fields.hasErrors('global')}" class="alert alert-danger">
                        <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                     </div>


                     <div>
                        <label for="contentText" class="block text-base font-medium text-gray-800 mb-2">
                            <span th:if="${makeupResubmissionAllowed}">Your Makeup Answer (Text)</span>
                            <span th:unless="${makeupResubmissionAllowed}">Your Answer (Text)</span>
                        </label>
                        <textarea id="contentText" th:field="*{contentText}" rows="10"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-base"
                                  placeholder="Type your answer here..."
                                  th:classappend="${#fields.hasErrors('contentText')} ? 'border-red-500' : ''"></textarea>
                         <p th:if="${#fields.hasErrors('contentText')}" th:errors="*{contentText}" class="text-xs text-red-600 mt-1"></p>
                    </div>

                    <div>
                        <label for="submissionFile" class="block text-base font-medium text-gray-800 mb-2">
                            <span th:if="${makeupResubmissionAllowed}">Upload New File for Makeup (Optional)</span>
                            <span th:unless="${makeupResubmissionAllowed}">Upload File (Optional)</span>
                         </label>
                         <input type="file" id="submissionFile" name="submissionFile" class="custom-file-input">
                         <p class="text-xs text-gray-600 mt-2">Max file size: 10MB. You can provide text, upload a file, or both.</p>
                         <p th:if="${makeupResubmissionAllowed and submission?.originalFilename != null}" class="text-xs text-gray-600 mt-1">
                             Original file: <strong th:text="${submission.originalFilename}"></strong>. Uploading a new file will replace it for the makeup.
                         </p>
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="w-full btn btn-success text-lg py-3 font-semibold shadow-md hover:shadow-lg transition-shadow duration-200">
                             <i class="fas fa-check-circle mr-2"></i>
                             <span th:if="${makeupResubmissionAllowed}">Submit Makeup Assignment</span>
                             <span th:unless="${makeupResubmissionAllowed}">Submit Assignment</span>
                        </button>
                    </div>
                </form>
            </section>

            <div class="mt-8 text-center pt-6 border-t border-gray-300">
                <a th:href="@{/student/assignments}" class="text-base font-medium text-purple-700 hover:text-purple-900 hover:underline">&larr; Back to Assignments List</a>
            </div>

        </div>
    </main>

</body>
</html>
