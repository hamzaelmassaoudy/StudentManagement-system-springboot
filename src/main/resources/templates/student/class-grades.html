<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <title th:text="'My Grades - ' + ${schoolClass.name}">My Class Grades</title>
     <style>
        /* Grade display styles (similar to dashboard) */
        .grade-badge {
             @apply inline-block px-2.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap;
        }
        .grade-badge-pass { @apply bg-green-100 text-green-800; }
        .grade-badge-fail { @apply bg-red-100 text-red-800; }
        .grade-badge-pending { @apply bg-blue-100 text-blue-800; } /* Submitted, not graded */
        .grade-badge-ungraded { @apply bg-yellow-100 text-yellow-800; } /* Quiz pending manual grade */
        .grade-badge-not-submitted { @apply bg-gray-100 text-gray-600; }
        .grade-badge-in-progress { @apply bg-yellow-100 text-yellow-800; }

        .item-link {
            @apply text-purple-600 hover:text-purple-800 hover:underline;
        }
     </style>
</head>

<body>
    <main th:fragment="main">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-3 border-b border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2 sm:mb-0" th:text="'My Grades: ' + ${schoolClass.name}">My Class Grades</h2>
            <a th:href="@{/student/classes}" class="text-sm text-purple-600 hover:underline">
                 &larr; Back to My Classes
             </a>
        </div>

        <div th:if="${assignments.isEmpty() and quizzes.isEmpty()}" class="text-center text-gray-500 py-10 italic border border-dashed border-gray-300 rounded-lg">
            No assignments or quizzes found for this class yet.
        </div>

        <div th:unless="${assignments.isEmpty() and quizzes.isEmpty()}" class="table-container bg-white">
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Title</th>
                        <th>Due Date</th>
                        <th>Status / Grade</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700">
                    <tr th:each="assignment : ${assignments}" class="hover:bg-gray-50">
                        <td class="text-sm font-medium text-purple-700"><i class="fas fa-file-alt mr-1"></i> Assignment</td>
                        <td class="text-sm font-medium">
                            <a class="item-link" th:href="@{/student/assignments/{id}/submit(id=${assignment.id})}" th:text="${assignment.title}"></a>
                        </td>
                        <td class="text-xs" th:text="${assignment.dueDate != null ? #temporals.format(assignment.dueDate, 'MMM dd, HH:mm') : 'N/A'}"></td> <td class="text-sm">
                            <th:block th:with="submission=${submissionMap.get(assignment.id)}">
                                <span th:if="${submission == null}" class="grade-badge grade-badge-not-submitted">Not Submitted</span>
                                <span th:if="${submission != null and submission.grade == null}" class="grade-badge grade-badge-pending">Submitted</span>
                                <span th:if="${submission != null and submission.grade != null}"
                                      class="grade-badge font-semibold"
                                      th:classappend="${submission.numericalGrade != null and submission.numericalGrade >= 60 ? 'grade-badge-pass' : 'grade-badge-fail'}"
                                      th:text="${submission.grade}">
                                      85.0
                                </span>
                            </th:block>
                        </td>
                        <td class="text-sm">
                             <a class="action-icon" th:href="@{/student/assignments/{id}/submit(id=${assignment.id})}" title="View/Submit Assignment">
                                <i class="fas fa-eye"></i>
                             </a>
                        </td>
                    </tr>
                    <tr th:each="quiz : ${quizzes}" class="hover:bg-gray-50">
                        <td class="text-sm font-medium text-blue-700"><i class="fas fa-question-circle mr-1"></i> Quiz</td>
                        <td class="text-sm font-medium" th:text="${quiz.title}"></td>
                        <td class="text-xs" th:text="${quiz.dueDate != null ? #temporals.format(quiz.dueDate, 'MMM dd, HH:mm') : 'N/A'}"></td>
                        <td class="text-sm">
                             <th:block th:with="attempt=${attemptMap.get(quiz.id)}, isPastDue=${quiz.dueDate != null and #temporals.createNow().isAfter(quiz.dueDate)}">
                                <span th:if="${attempt == null and isPastDue}" class="grade-badge grade-badge-fail">Past Due</span>
                                <span th:if="${attempt == null and !isPastDue}" class="grade-badge grade-badge-not-submitted">Not Started</span>
                                <span th:if="${attempt != null and attempt.status.name() == 'IN_PROGRESS' and !isPastDue}" class="grade-badge grade-badge-in-progress">In Progress</span>
                                <span th:if="${attempt != null and attempt.status.name() == 'IN_PROGRESS' and isPastDue}" class="grade-badge grade-badge-fail">In Progress (Past Due)</span>
                                <span th:if="${attempt != null and attempt.status.name() == 'SUBMITTED'}" class="grade-badge grade-badge-pending">Submitted</span>
                                <span th:if="${attempt != null and attempt.status.name() == 'GRADED'}"
                                      class="grade-badge font-semibold"
                                      th:classappend="${attempt.score != null and attempt.maxScore != null and attempt.maxScore > 0 and (attempt.score / attempt.maxScore * 100) >= 60 ? 'grade-badge-pass' : 'grade-badge-fail'}"
                                      th:text="${(attempt.score != null ? #numbers.formatDecimal(attempt.score, 1, 1) : 'N/A') + '/' + (attempt.maxScore != null ? attempt.maxScore : '?')}">
                                      8.5/10
                                </span>
                             </th:block>
                        </td>
                         <td class="text-sm">
                             <th:block th:with="attempt=${attemptMap.get(quiz.id)}, isPastDue=${quiz.dueDate != null and #temporals.createNow().isAfter(quiz.dueDate)}">
                                 <a th:if="${attempt == null and !isPastDue}"
                                    th:href="@{/student/quizzes/{quizId}/take(quizId=${quiz.id})}"
                                    class="action-icon" title="Start Quiz">
                                     <i class="fas fa-play text-green-600"></i>
                                 </a>
                                 <a th:if="${attempt != null and attempt.status.name() == 'IN_PROGRESS' and !isPastDue}"
                                    th:href="@{/student/quizzes/{quizId}/take(quizId=${quiz.id})}"
                                    class="action-icon" title="Continue Quiz">
                                     <i class="fas fa-edit text-yellow-600"></i>
                                 </a>
                                  <a th:if="${attempt != null and (attempt.status.name() == 'SUBMITTED' or attempt.status.name() == 'GRADED')}"
                                    th:href="@{/student/quizzes/result/{attemptId}(attemptId=${attempt.id})}"
                                    class="action-icon" title="View Result">
                                     <i class="fas fa-poll-h text-indigo-600"></i>
                                 </a>
                                  <span th:if="${(attempt == null or attempt.status.name() == 'IN_PROGRESS') and isPastDue}" class="text-xs text-red-500 italic">Past Due</span>
                             </th:block>
                         </td>
                    </tr>
                </tbody>
            </table>
        </div>
         <div class="mt-8 text-center">
             <a th:href="@{/dashboard}" class="text-sm text-purple-600 hover:underline">&larr; Back to Dashboard</a>
        </div>
    </main>
</body>
</html>