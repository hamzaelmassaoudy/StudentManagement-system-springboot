<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
    <title th:text="${filterClassName != null and filterClassName != 'All Classes'} ? 'Assignments for ' + ${filterClassName} : 'My Assignments'">My Assignments</title>
    <style>
        /* Enhanced action icon styles for better visual feedback */
        .action-icon {
            @apply inline-flex items-center justify-center p-1.5 rounded-md text-gray-500
                   hover:text-gray-800 hover:bg-gray-100
                   focus:outline-none focus:ring-2 focus:ring-inset focus:ring-purple-500
                   transition-colors duration-150;
            /* Ensure icons have a fixed size */
            i { @apply w-4 h-4; }
        }
        /* Specific hover colors */
        .action-icon.submit:hover { @apply !text-green-600; } /* Use !important if needed */
        .action-icon.view:hover { @apply !text-indigo-600; }
        .action-icon.makeup:hover { @apply !text-orange-600; }

        /* Grade text colors */
        .grade-pass { @apply text-green-600; }
        .grade-fail { @apply text-red-600; }
        .grade-pending { @apply text-blue-600; } /* For pending manual grade after submission */
        .grade-not-submitted { @apply text-gray-500 italic; }
        .grade-submitted { @apply text-green-600 italic; } /* For when submitted but not yet graded */

    </style>
</head>

<body>

    <main th:fragment="main" class="px-4 py-6 md:px-6 md:py-8 lg:py-10">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-3 border-b border-gray-200">
             <h2 class="text-2xl font-semibold text-gray-800 mb-2 sm:mb-0"
                th:text="${filterClassName != null and filterClassName != 'All Classes'} ? 'Assignments for ' + ${filterClassName} : 'My Assignments'">
                My Assignments
            </h2>
             <a th:if="${filterClassName != null and filterClassName != 'All Classes'}" th:href="@{/student/assignments}"
               class="text-sm font-medium text-purple-600 hover:text-purple-800 hover:underline">
                Show All Assignments
            </a>
        </div>

        <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                         <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attachment</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade / Status</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-gray-700">
                        <tr th:each="assignment : ${assignments}" th:if="${!assignments.isEmpty()}" class="hover:bg-gray-50 transition-colors duration-150">
                            <th:block th:with="statusDetails=${assignmentStatusMap.get(assignment.id)}, submission=${statusDetails?.get('submission')}, makeupStatus=${statusDetails?.get('makeupStatus')}">

                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600" th:text="${assignment.schoolClass?.name}">Class Name</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${assignment.title}">Assignment Title</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600" th:text="${#temporals.format(assignment.dueDate, 'yyyy-MM-dd HH:mm')}">Due Date</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <a th:if="${assignment.attachmentPath != null}"
                                       th:href="@{/download/assignment/{filename}(filename=${assignment.attachmentPath})}"
                                       target="_blank" class="download-link text-purple-600 hover:text-purple-800 inline-flex items-center gap-1">
                                         <i class="fas fa-download text-xs"></i>
                                         <span class="truncate max-w-xs" th:text="${assignment.attachmentOriginalFilename}">filename.pdf</span>
                                    </a>
                                    <span th:unless="${assignment.attachmentPath != null}" class="text-xs text-gray-400 italic">None</span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <span th:if="${submission != null}">
                                        <span th:if="${submission.grade != null}"
                                              class="font-semibold"
                                              th:classappend="${submission.numericalGrade == null ? 'grade-pending' : (submission.numericalGrade >= 60 ? 'grade-pass' : 'grade-fail')}"
                                              th:text="${submission.grade}">
                                              85.0
                                        </span>
                                        <span th:if="${submission.grade == null}" class="grade-submitted text-xs">
                                            Submitted <span th:if="${submission.isMakeupSubmission()}">(Makeup)</span> - Pending Grade
                                        </span>
                                        <span th:if="${makeupStatus == 'PENDING'}" class="ml-1 text-xs text-yellow-600 italic">(Makeup Pending)</span>
                                         <span th:if="${makeupStatus == 'REJECTED'}" class="ml-1 text-xs text-red-600 italic">(Makeup Rejected)</span>
                                         </span>
                                    <span th:if="${submission == null}" class="grade-not-submitted text-xs">
                                        Not Submitted
                                    </span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <div class="flex items-center space-x-1">
                                        <th:block th:with="canResubmitMakeup=${makeupStatus == 'APPROVED' and submission != null and submission.grade != null}">
                                            <a th:href="@{/student/assignments/{id}/submit(id=${assignment.id})}"
                                               class="action-icon"
                                               th:classappend="${submission != null} ? 'view' : 'submit'"
                                               th:title="${submission == null ? 'Submit Assignment' : (canResubmitMakeup ? 'Resubmit Makeup' : 'View Submission')}"
                                               th:aria-label="${submission == null ? 'Submit Assignment' : (canResubmitMakeup ? 'Resubmit Makeup Assignment' : 'View Submission Details')}">
                                               <i th:classappend="${submission == null ? 'fas fa-upload' : (canResubmitMakeup ? 'fas fa-edit' : 'fas fa-eye')}"></i>
                                            </a>
                                        </th:block>

                                        <th:block th:if="${submission != null and submission.numericalGrade != null and submission.numericalGrade < 60 and !submission.isMakeupSubmission() and makeupStatus != 'PENDING' and makeupStatus != 'APPROVED'}">
                                            <a th:href="@{/student/makeup/request/{subId}(subId=${submission.id})}"
                                                    class="action-icon makeup"
                                                    title="Apply for Makeup">
                                                <span class="sr-only">Apply for Makeup</span>
                                                <i class="fas fa-redo-alt"></i>
                                            </a>
                                        </th:block>
                                    </div>
                                </td>
                            </th:block> </tr>
                        <tr th:if="${assignments.isEmpty()}">
                            <td colspan="6" class="px-6 py-8 text-center text-sm text-gray-500 italic">
                                No assignments found. Check your enrolled classes or use the "Join Class" link.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-6 text-center">
             <a th:href="@{/dashboard}" class="text-sm font-medium text-purple-600 hover:text-purple-800 hover:underline">&larr; Back to Dashboard</a>
        </div>
    </main>

</body>
</html>
