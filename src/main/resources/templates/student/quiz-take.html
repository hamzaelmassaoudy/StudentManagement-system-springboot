<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, ~{::main})}">

<head>
    <title th:text="'Take Quiz: ' + ${quiz.title}">Take Quiz</title>
    <style>
        /* Styles remain the same */
        .question-block { @apply mb-6 p-5 border border-gray-200 rounded-lg bg-white shadow-sm; }
        .question-header { @apply flex justify-between items-baseline mb-3 pb-2 border-b border-gray-100; }
        .question-number { @apply text-sm font-semibold text-purple-700; }
        .question-points { @apply text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full; }
        .question-text { @apply text-base text-gray-800 mb-3 leading-relaxed; }
        .answer-textarea { @apply w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm; min-height: 80px; }
        #timer-section { @apply fixed bottom-4 right-4 bg-red-600 text-white text-lg font-bold px-4 py-2 rounded-full shadow-lg z-50; min-width: 80px; text-align: center; }
        #timer-section.ending { @apply bg-red-700 animate-pulse; }
    </style>
</head>

<body>
<main th:fragment="main">
    <div class="mb-6 pb-3 border-b border-gray-300">
        <h2 class="text-2xl font-semibold text-gray-800" th:text="${quiz.title}">Quiz Title</h2>
        <p class="text-sm text-gray-600 mt-1" th:text="${quiz.description}">Quiz description.</p>
        <p class="text-xs text-gray-500 mt-1">Class: <span th:text="${quiz.schoolClass?.name}">Class Name</span></p>
        <p th:if="${quiz.timeLimitMinutes != null}" class="text-sm text-red-600 font-medium mt-2">
            <i class="fas fa-stopwatch mr-1"></i> Time Limit: <span th:text="${quiz.timeLimitMinutes}">60</span> minutes
        </p>
    </div>

    <div th:if="${quiz.timeLimitMinutes != null}" id="timer-section">
        <span id="timer">--:--</span>
    </div>

    <form id="quizForm" th:action="@{/student/quizzes/submit/{attemptId}(attemptId=${attempt.id})}" th:object="${quizSubmissionDto}" method="post">
        <input type="hidden" th:field="*{quizId}" />
        <div th:each="question, iterStat : ${quiz.questions}" class="question-block">
            <div class="question-header">
                <span class="question-number" th:text="'Question ' + ${iterStat.count}">Question 1</span>
                <span class="question-points" th:text="${question.points} + ' points'">5 points</span>
            </div>
            <p class="question-text" th:text="${question.questionText}">Question text goes here...</p>

            <input type="hidden" th:name="|answers[${iterStat.index}].questionId|" th:value="${question.id}" />

            <div th:if="${question.questionType.name() == 'SHORT_ANSWER'}">
                <label th:for="|answerText${iterStat.index}|" class="block text-sm font-medium text-gray-700 mb-1">Your Answer:</label>
                <textarea th:id="|answerText${iterStat.index}|"
                          th:name="|answers[${iterStat.index}].answerText|"
                          rows="4"
                          class="answer-textarea"
                          placeholder="Type your answer here..."></textarea>
            </div>

             <div th:unless="${question.questionType.name() == 'SHORT_ANSWER'}">
                  <p class="text-red-500 text-sm italic">(Unsupported question type)</p>
             </div>

        </div>

        <div class="mt-8 text-center">
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-circle mr-2"></i> Submit Quiz
            </button>
        </div>
    </form>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const attemptStartTimeMillis = /*[[${attemptStartTimeMillis}]]*/ null;
        const quizEndTimeMillis = /*[[${quizEndTimeMillis}]]*/ null;
        const quizForm = document.getElementById('quizForm');
        const timerDisplay = document.getElementById('timer');
        const timerSection = document.getElementById('timer-section');
        let timerInterval = null;

        function updateTimer() {
            if (!quizEndTimeMillis || !timerDisplay) {
                if (timerInterval) clearInterval(timerInterval);
                return; // No time limit or display element found
            }
            const nowMillis = Date.now();
            const remainingMillis = quizEndTimeMillis - nowMillis;

            if (remainingMillis <= 0) {
                timerDisplay.textContent = "00:00";
                clearInterval(timerInterval);
                console.log("Time's up! Submitting form.");
                if (quizForm) { quizForm.submit(); }
            } else {
                const totalSeconds = Math.floor(remainingMillis / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                timerDisplay.textContent = String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');
                if (remainingMillis < 5 * 60 * 1000 && timerSection) { timerSection.classList.add('ending'); }
                else if (timerSection) { timerSection.classList.remove('ending'); }
            }
        }

        if (quizEndTimeMillis && attemptStartTimeMillis && timerDisplay) {
            console.log("Starting quiz timer. End time (ms):", quizEndTimeMillis);
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        } else if (timerSection) {
             timerSection.style.display = 'none';
        }

        window.addEventListener('beforeunload', function (e) {
            if (timerInterval) { // Only warn if timer is running
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your quiz progress might not be saved if you haven\'t submitted.';
            }
        });
        /*]]>*/
    </script>

</main>
</body>
</html>
